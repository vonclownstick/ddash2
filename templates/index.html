<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MGB Psychiatry Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body class="bg-gray-50 text-gray-800 font-sans text-sm">

    <nav class="bg-slate-900 text-white p-3 shadow-lg sticky top-0 z-40">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <button id="hamburger-btn" class="text-white hover:bg-slate-800 p-2 rounded transition" onclick="toggleHamburger()">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                <h1 class="text-xl font-bold tracking-tight">MGB Psychiatry <span class="font-light text-blue-200">Dashboard</span></h1>
            </div>
            <div id="status-container" class="text-xs flex items-center gap-3">
                {% if status == 'Ready' %}
                    <span class="px-2 py-1 rounded bg-emerald-600 font-medium">Status: Ready</span>
                {% elif 'Error' in status %}
                    <span class="px-2 py-1 rounded bg-red-600 font-medium">Status: {{ status }}</span>
                {% else %}
                    <span class="px-2 py-1 rounded bg-amber-500 font-medium animate-pulse" hx-get="/status_fragment" hx-trigger="load delay:1s" hx-swap="outerHTML">{{ status }}</span>
                {% endif %}
                <span class="opacity-75">Updated: {{ last_updated }}</span>
            </div>
        </div>
    </nav>

    <!-- Hamburger Menu -->
    <div id="hamburger-menu" class="hidden fixed top-14 left-0 bg-white shadow-lg border border-gray-200 rounded-br-lg z-50 w-48">
        <div class="py-2">
            <button onclick="showAboutModal()" class="w-full text-left px-4 py-2 hover:bg-gray-100 text-sm text-gray-700 transition">
                About
            </button>
            <button onclick="showHelpModal()" class="w-full text-left px-4 py-2 hover:bg-gray-100 text-sm text-gray-700 transition border-t border-gray-200">
                Help
            </button>
            <button onclick="logout()" class="w-full text-left px-4 py-2 hover:bg-gray-100 text-sm text-gray-700 transition border-t border-gray-200">
                Logout
            </button>
        </div>
    </div>

    <div class="container mx-auto mt-6 px-4 mb-4">
        <div class="flex flex-col md:flex-row justify-between items-end gap-4">
            <div class="w-full md:w-auto">
                <h2 class="text-lg font-semibold text-gray-800">Investigator Performance</h2>
                <p class="text-gray-500 text-xs mt-0.5">Publications (24mo) & NIH Funding (5y)</p>
            </div>
            <div class="flex items-center gap-2 w-full md:w-auto">
                <div class="relative w-full md:w-48">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-4 w-4 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                    </div>
                    <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Find Investigator..." class="pl-10 pr-3 py-1.5 w-full border border-gray-300 rounded text-xs focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                </div>

                <!-- Smart Search Button -->
                <button onclick="showSmartSearchModal()" class="bg-amber-500 hover:bg-amber-600 text-white p-2 rounded-full shadow-lg transition duration-150 shrink-0" title="Smart Search">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                </button>

                <!-- 3D Visualization Button -->
                <button onclick="show3DVisualization()" class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-full shadow-lg transition duration-150 shrink-0" title="3D Visualization">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                </button>

                {% if is_admin %}
                <button hx-post="/refresh_pubs" hx-target="#status-container" hx-swap="outerHTML"
                        {% if status != 'Ready' and 'Error' not in status %}disabled class="opacity-50 cursor-not-allowed bg-gray-400 text-white font-semibold py-1.5 px-3 rounded text-xs"{% else %}class="bg-blue-700 hover:bg-blue-800 text-white font-semibold py-1.5 px-3 rounded shadow transition duration-150 flex items-center gap-1 text-xs shrink-0"{% endif %}>
                    Pubs
                </button>
                <button hx-post="/refresh_grants" hx-target="#status-container" hx-swap="outerHTML"
                        {% if status != 'Ready' and 'Error' not in status %}disabled class="opacity-50 cursor-not-allowed bg-gray-400 text-white font-semibold py-1.5 px-3 rounded text-xs"{% else %}class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-1.5 px-3 rounded shadow transition duration-150 flex items-center gap-1 text-xs shrink-0"{% endif %}>
                    Grants
                </button>
                <button hx-post="/refresh_ai" hx-target="#status-container" hx-swap="outerHTML"
                        {% if status != 'Ready' and 'Error' not in status %}disabled class="opacity-50 cursor-not-allowed bg-gray-400 text-white font-semibold py-1.5 px-3 rounded text-xs"{% else %}class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-1.5 px-3 rounded shadow transition duration-150 flex items-center gap-1 text-xs shrink-0"{% endif %}>
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                    AI Profile
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 pb-20">
        <div class="bg-white rounded-lg shadow border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table id="mainTable" class="min-w-full text-xs">
                    <thead class="bg-gray-100 text-gray-700 uppercase font-bold border-b border-gray-200">
                        <tr>
                            <th onclick="sortTable(0)" class="px-3 py-2 text-left sortable-header sort-icon">Investigator</th>
                            <th onclick="sortTable(1)" class="px-3 py-2 text-right sortable-header sort-icon">Total Papers</th>
                            <th onclick="sortTable(2)" class="px-3 py-2 text-right sortable-header sort-icon desc" data-dir="desc">Total RCR</th>
                            <th onclick="sortTable(3)" class="px-3 py-2 text-right sortable-header sort-icon">Papers (12m)</th>
                            <th onclick="sortTable(4)" class="px-3 py-2 text-right sortable-header sort-icon">Vol % &Delta;</th>
                            <th onclick="sortTable(5)" class="px-3 py-2 text-right sortable-header sort-icon border-l border-gray-200">Active Funding</th>
                            <th onclick="sortTable(6)" class="px-3 py-2 text-right sortable-header sort-icon">5y Total</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 bg-white">
                        {% for inv in investigators %}
                        <tr class="hover:bg-blue-50 transition duration-150 group">
                            <td class="px-3 py-2 font-medium text-gray-900 cursor-pointer text-blue-600 group-hover:underline decoration-blue-400 underline-offset-2"
                                hx-get="/investigator/{{ inv.id }}" hx-target="#modal-content" onclick="document.getElementById('modal').classList.remove('hidden'); document.getElementById('modal-title').innerText = '{{ inv.name | replace("'", "") }}';">
                                {{ inv.name }}
                            </td>
                            <td class="px-3 py-2 text-right text-gray-600" data-sort="{{ inv.total_papers }}">{{ inv.total_papers }}</td>
                            <td class="px-3 py-2 text-right font-mono font-medium text-slate-700" data-sort="{{ inv.total_icite }}">{{ "%.2f"|format(inv.total_icite) }}</td>
                            <td class="px-3 py-2 text-right font-bold text-gray-800" data-sort="{{ inv.n_p2 }}">{{ inv.n_p2 }}</td>
                            <td class="px-3 py-2 text-right" data-sort="{{ inv.delta_n_val }}">
                                {% if inv.delta_n_val > 0 %}<span class="text-emerald-600 font-bold bg-emerald-50 px-1.5 py-0.5 rounded">‚Üë {{ inv.delta_n_str }}</span>
                                {% elif inv.delta_n_val < 0 %}<span class="text-rose-500 bg-rose-50 px-1.5 py-0.5 rounded">‚Üì {{ inv.delta_n_str }}</span>
                                {% else %}<span class="text-gray-400 text-[10px]">-</span>{% endif %}
                            </td>

                            <td class="px-3 py-2 text-right font-medium text-emerald-700 border-l border-gray-100" data-sort="{{ inv.funding_current }}">
                                {% if inv.funding_current > 0 %}${{ "{:,.0f}".format(inv.funding_current/1000) }}k{% else %}<span class="text-gray-300">-</span>{% endif %}
                            </td>
                            <td class="px-3 py-2 text-right text-gray-600" data-sort="{{ inv.funding_past_5y }}">
                                {% if inv.funding_past_5y > 0 %}${{ "{:,.1f}".format(inv.funding_past_5y/1000000) }}M{% else %}<span class="text-gray-300">-</span>{% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Investigator Detail Modal -->
    <div id="modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 overflow-y-auto h-full w-full z-50 backdrop-blur-sm">
        <div class="relative top-20 mx-auto p-0 border-0 w-11/12 md:w-3/4 lg:w-1/2 shadow-2xl rounded-xl bg-white overflow-hidden animate-[fadeIn_0.2s_ease-out]">
            <div class="flex justify-between items-center p-4 border-b bg-gray-50">
                <h3 id="modal-title" class="text-lg font-bold text-gray-800">Investigator Details</h3>
                <button onclick="document.getElementById('modal').classList.add('hidden')" class="text-gray-400 hover:text-red-500 transition text-2xl leading-none">&times;</button>
            </div>
            <div id="modal-content" class="p-0 modal-body overflow-y-auto min-h-[300px]">
                <div class="flex justify-center p-10"><p class="text-gray-500 animate-pulse">Loading data...</p></div>
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div id="about-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 overflow-y-auto h-full w-full z-50 backdrop-blur-sm">
        <div class="relative top-40 mx-auto p-0 border-0 w-11/12 md:w-96 shadow-2xl rounded-xl bg-white overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b bg-gradient-to-r from-blue-600 to-purple-600 text-white">
                <h3 class="text-lg font-bold">About DDash</h3>
                <button onclick="closeAboutModal()" class="text-white hover:text-gray-200 transition text-2xl leading-none">&times;</button>
            </div>
            <div class="p-8 text-center">
                <div class="mb-4">
                    <svg class="w-16 h-16 mx-auto text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                </div>
                <h4 class="text-2xl font-bold text-gray-800 mb-2">DDash v0.62</h4>
                <p class="text-sm text-gray-600 mb-6">Dashboard for Research Metrics</p>
                <div class="text-xs text-gray-500 border-t pt-4">
                    <p>&copy; 2025 Roy Perlis and MGH CQH</p>
                    <p class="mt-1">All rights reserved</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 overflow-y-auto h-full w-full z-50 backdrop-blur-sm">
        <div class="relative top-20 mx-auto p-0 border-0 w-11/12 md:w-3/4 lg:w-1/2 shadow-2xl rounded-xl bg-white overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b bg-gradient-to-r from-green-600 to-teal-600 text-white">
                <div class="flex items-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <h3 class="text-lg font-bold">Help</h3>
                </div>
                <button onclick="closeHelpModal()" class="text-white hover:text-gray-200 transition text-2xl leading-none">&times;</button>
            </div>
            <div class="p-6">
                {% if user_type == 'admin' %}
                <div class="space-y-4">
                    <div>
                        <h4 class="text-lg font-bold text-gray-800 mb-2">Admin Access</h4>
                        <p class="text-sm text-gray-600 mb-3">You have full administrative access to the dashboard.</p>
                    </div>

                    <div class="border-t pt-4">
                        <h5 class="font-semibold text-gray-800 mb-2">Features:</h5>
                        <ul class="list-disc list-inside space-y-1 text-sm text-gray-700">
                            <li><strong>Search:</strong> Use the text box to filter investigators by name</li>
                            <li><strong>‚ö° Smart Search:</strong> Click the lightning bolt to search by research expertise using natural language (e.g., "AI for stroke in older adults")</li>
                            <li><strong>Pubs Button:</strong> Refresh publication data from PubMed</li>
                            <li><strong>Grants Button:</strong> Refresh grant data from NIH RePORTER</li>
                            <li><strong>AI Profile Button:</strong> Update AI-powered research themes and populations</li>
                            <li><strong>Click Rows:</strong> Click any investigator row to see detailed publications and grants</li>
                            <li><strong>Sort Columns:</strong> Click column headers to sort data</li>
                        </ul>
                    </div>
                </div>
                {% elif user_type == 'user' %}
                <div class="space-y-4">
                    <div>
                        <h4 class="text-lg font-bold text-gray-800 mb-2">User Access</h4>
                        <p class="text-sm text-gray-600 mb-3">You have read-only access to view investigator metrics.</p>
                    </div>

                    <div class="border-t pt-4">
                        <h5 class="font-semibold text-gray-800 mb-2">Features:</h5>
                        <ul class="list-disc list-inside space-y-1 text-sm text-gray-700">
                            <li><strong>Search:</strong> Use the text box to filter investigators by name</li>
                            <li><strong>‚ö° Smart Search:</strong> Click the lightning bolt to search by research expertise using natural language (e.g., "depression treatment in adolescents")</li>
                            <li><strong>Click Rows:</strong> Click any investigator row to see detailed publications and grants</li>
                            <li><strong>Sort Columns:</strong> Click column headers to sort data</li>
                        </ul>
                    </div>

                    <div class="bg-blue-50 border-l-4 border-blue-400 p-3 mt-4">
                        <p class="text-sm text-gray-700"><strong>Note:</strong> You cannot refresh data, but the dashboard updates automatically when admins run refreshes.</p>
                    </div>
                </div>
                {% else %}
                <div class="space-y-4">
                    <div>
                        <h4 class="text-lg font-bold text-gray-800 mb-2">Search-Focused View</h4>
                        <p class="text-sm text-gray-600 mb-3">This view focuses on finding investigators by their research expertise.</p>
                    </div>

                    <div class="border-t pt-4">
                        <h5 class="font-semibold text-gray-800 mb-2">How to Use:</h5>
                        <ul class="list-disc list-inside space-y-2 text-sm text-gray-700">
                            <li><strong>‚ö° Smart Search:</strong> Click the lightning bolt button to search for investigators
                                <ul class="list-disc list-inside ml-6 mt-1 space-y-1 text-xs text-gray-600">
                                    <li>Enter research topics in natural language</li>
                                    <li>Examples: "machine learning for suicide risk", "GWAS studies of autism", "clinical trials for bipolar disorder"</li>
                                    <li>Results show investigator names, technologies/methods, and study populations</li>
                                </ul>
                            </li>
                            <li><strong>Regular Search:</strong> Use the text box to filter results by investigator name</li>
                            <li><strong>View Details:</strong> The table shows investigator names with their research focus areas and populations</li>
                        </ul>
                    </div>

                    <div class="bg-amber-50 border-l-4 border-amber-400 p-3 mt-4">
                        <p class="text-sm text-gray-700"><strong>Tip:</strong> Smart Search uses AI to understand your research interests and find the best matches based on publications, grants, and research themes.</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Smart Search Modal -->
    <div id="smart-search-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 overflow-y-auto h-full w-full z-50 backdrop-blur-sm">
        <div class="relative top-20 mx-auto p-0 border-0 w-11/12 md:w-3/4 lg:w-2/3 shadow-2xl rounded-xl bg-white overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b bg-gradient-to-r from-amber-500 to-orange-500 text-white">
                <div class="flex items-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    <h3 class="text-lg font-bold">Smart Search</h3>
                </div>
                <button onclick="closeSmartSearchModal()" class="text-white hover:text-gray-200 transition text-2xl leading-none">&times;</button>
            </div>
            <div class="p-6">
                <form id="smart-search-form" onsubmit="performSmartSearch(event)">
                    <div class="mb-4">
                        <label for="smart-query" class="block text-sm font-medium text-gray-700 mb-2">
                            Describe the research expertise you're looking for:
                        </label>
                        <textarea id="smart-query" name="query" rows="3"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent text-sm"
                                  placeholder="e.g., AI for stroke in older adults using claims data, depression treatment in adolescents, machine learning for predicting suicide risk..."></textarea>
                    </div>
                    <div class="flex justify-end gap-2">
                        <button type="button" onclick="closeSmartSearchModal()"
                                class="px-4 py-2 text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-lg transition text-sm font-medium">
                            Cancel
                        </button>
                        <button type="submit" id="search-btn"
                                class="px-6 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-lg transition text-sm font-semibold shadow-lg flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            Search
                        </button>
                    </div>
                </form>

                <!-- Results Area -->
                <div id="search-results" class="mt-6 hidden">
                    <div class="border-t pt-4">
                        <h4 class="text-sm font-bold text-gray-700 mb-3">Top Matches:</h4>
                        <div id="results-list"></div>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="search-loading" class="mt-6 hidden text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-amber-500"></div>
                    <p class="mt-3 text-sm text-gray-600">Analyzing query and searching...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 3D Visualization Modal -->
    <div id="viz-3d-modal" class="hidden fixed inset-0 bg-gray-900 z-50">
        <div class="w-full h-full flex flex-col">
            <!-- Header -->
            <div class="bg-slate-800 text-white p-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                    <h3 class="text-lg font-bold">3D Research Landscape</h3>
                </div>
                <button onclick="close3DVisualization()" class="text-white hover:text-gray-300 transition text-2xl leading-none">&times;</button>
            </div>

            <!-- Controls -->
            <div class="bg-slate-700 text-white p-3 flex items-center gap-4 text-sm">
                <div class="flex items-center gap-2">
                    <label for="search-investigator" class="font-medium">Find:</label>
                    <input type="text" id="search-investigator" placeholder="Type investigator name..."
                           class="px-3 py-1 rounded bg-slate-600 text-white border border-slate-500 focus:border-blue-400 focus:outline-none w-64"
                           onkeyup="searchInvestigator(event)">
                </div>
                <div class="ml-auto text-xs text-gray-300">
                    <span class="mr-4">üñ±Ô∏è Drag to rotate | Scroll to zoom</span>
                    <span id="viz-info"></span>
                </div>
            </div>

            <!-- 3D Canvas -->
            <div id="viz-container" class="flex-1 relative bg-black">
                <div id="viz-loading" class="absolute inset-0 flex items-center justify-center bg-gray-900 text-white">
                    <div class="text-center">
                        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mb-4"></div>
                        <p class="text-sm">Loading 3D visualization...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Three.js r132 - last version with easy OrbitControls support -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/renderers/CSS2DRenderer.js"></script>
    <script src="/static/app.js?v=8"></script>
</body>
</html>
